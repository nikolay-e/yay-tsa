minimum_pre_commit_version: '3.7.0'
default_stages: [pre-commit]
default_language_version:
  node: system
fail_fast: false # Run all hooks to get complete feedback

repos:
  # ------------------------------------------------------------------------------
  # GENERAL FILE HYGIENE (Mostly Autofixing)
  # Basic checks and fixes for all text files.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace # [AUTOFIX] Removes trailing whitespace.
        args: [--markdown-linebreak-ext=md]
      - id: end-of-file-fixer # [AUTOFIX] Ensures files end with a newline.
      - id: mixed-line-ending # [AUTOFIX] Forces LF line endings.
        args: [--fix=lf]
      - id: fix-byte-order-marker # [AUTOFIX] Removes UTF-8 BOM.
      - id: check-added-large-files # [CHECK] Prevents committing large files (>1MB).
        args: [--maxkb=1024]
      - id: check-merge-conflict # [CHECK] Prevents committing merge conflict markers.
      - id: check-case-conflict # [CHECK] Catches file path case inconsistencies.
      - id: detect-private-key # [CHECK] Prevents leaking private keys.
      - id: check-json # [CHECK] Validates JSON syntax.
      - id: check-yaml # [CHECK] Validates YAML syntax.
        args: [--unsafe] # Specific to this project: Allows custom Docker Compose tags.
        exclude: ^charts/.*/templates/.*\.yaml$

  # ------------------------------------------------------------------------------
  # EMOJI REMOVAL (Autofixing)
  # Removes emoji characters from source code files.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/nikolay-e/pre-commit-hooks
    rev: v2.0.1
    hooks:
      - id: no-emoji
        files: ^(packages|apps|services)/.*\.(ts|tsx|js|jsx|py|java)$

  # ------------------------------------------------------------------------------
  # PRETTIER CODE FORMATTER (Autofixing)
  # The main formatter for TS, React, YAML, MD, and CSS.
  # Includes Tailwind class sorting via prettier-plugin-tailwindcss.
  # ------------------------------------------------------------------------------
  - repo: local
    hooks:
      - id: prettier
        name: 'Prettier (code formatter + Tailwind sort)'
        entry: npx --no-install prettier --write --ignore-unknown --plugin=prettier-plugin-tailwindcss
        language: system
        types_or: [javascript, jsx, ts, tsx, css, scss, markdown, yaml, json]
        exclude: ^(package-lock\.json|pnpm-lock\.yaml|yarn\.lock|charts/)

  # ------------------------------------------------------------------------------
  # MARKDOWN LINTING (Autofixing)
  # Lints and fixes Markdown files using your existing .markdownlint.yaml config.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.47.0
    hooks:
      - id: markdownlint
        args: [--fix, --config, .markdownlint.yaml]

  # ------------------------------------------------------------------------------
  # SHELL SCRIPT FORMATTING & LINTING (Autofixing + Check)
  # Specific to this project: docker-entrypoint.sh, run-integration-tests.sh, etc.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/scop/pre-commit-shfmt
    rev: v3.12.0-2
    hooks:
      - id: shfmt # [AUTOFIX] Formats shell scripts for consistency.
        args: [-w, -i, '2'] # -w: write changes, -i 2: indent with 2 spaces.

  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.11.0.1
    hooks:
      - id: shellcheck # [CHECK] Lints shell scripts for common errors.
        args: [-x]

  # ------------------------------------------------------------------------------
  # DOCKER & INFRASTRUCTURE LINTING (Quality & Security)
  # Validates Dockerfiles, docker-compose, and infrastructure config.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/hadolint/hadolint
    rev: v2.14.0
    hooks:
      - id: hadolint-docker # [CHECK] Dockerfile best practices and security linting.
        args: [--config, .hadolint.yaml]

  # ------------------------------------------------------------------------------
  # SECRET DETECTION (Security)
  # Prevents committing secrets, API keys, tokens, and credentials.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.30.0
    hooks:
      - id: gitleaks # [CHECK] Scans for hardcoded secrets and credentials.

  # ------------------------------------------------------------------------------
  # SEMANTIC SECURITY ANALYSIS (Advanced)
  # AST-based security scanner for JavaScript/TypeScript.
  # More powerful than basic ESLint security rules.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/returntocorp/semgrep
    rev: v1.89.0
    hooks:
      - id: semgrep
        name: semgrep (JS/TS security & best practices)
        args:
          - --config=p/javascript
          - --config=p/typescript
          - --config=p/react
          - --error
          - --skip-unknown-extensions
          - --metrics=off
        files: ^(packages|apps)/.*\.(js|ts|tsx)$

  # ------------------------------------------------------------------------------
  # SPELL CHECKING (Documentation Quality)
  # Reduces typos in code, comments, and documentation.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/codespell-project/codespell
    rev: v2.4.1
    hooks:
      - id: codespell
        name: codespell (spell checker)
        args:
          - --ignore-words-list=afterall,beforeall,aftereach,beforeeach,alltogether,errorprone
          - --skip=package-lock.json,pnpm-lock.yaml,jellyfin-api-spec.json,node_modules,dist,build

  # ------------------------------------------------------------------------------
  # YAML LINTING (Strict Validation)
  # More comprehensive than basic check-yaml.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.38.0
    hooks:
      - id: yamllint
        name: yamllint (YAML linting)
        args:
          - -d
          - >-
            {extends: default,
            rules: {line-length: {max: 120},
            document-start: disable,
            indentation: disable,
            comments: disable}}
        exclude: ^(charts/.*/templates/.*\.yaml|\.github/.*\.yml)$

  # ------------------------------------------------------------------------------
  # GITHUB ACTIONS VALIDATION (CI/CD Quality)
  # Validates GitHub Actions workflow syntax and best practices.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/rhysd/actionlint
    rev: v1.7.10
    hooks:
      - id: actionlint-docker # [CHECK] Lints GitHub Actions workflow files.

  # ------------------------------------------------------------------------------
  # CSS QUALITY (Stylelint)
  # Validates CSS in .css files.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/thibaudcolas/pre-commit-stylelint
    rev: v17.0.0
    hooks:
      - id: stylelint # [CHECK/AUTOFIX] CSS quality and consistency.
        args: [--fix, --config, .stylelintrc.json]
        additional_dependencies:
          - stylelint@16.12.0
          - stylelint-config-standard@29.0.0
          - stylelint-config-recommended@13.0.0

  # ------------------------------------------------------------------------------
  # JAVA CODE FORMATTING (Google Java Format)
  # Auto-formats Java code using Google's standard style.
  # Requires Java 11+ installed.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/macisamuele/language-formatters-pre-commit-hooks
    rev: v2.16.0
    hooks:
      - id: pretty-format-java
        name: 'Google Java Format (autofix)'
        args: [--autofix]
        files: ^services/server/src/.*\.java$

  # ------------------------------------------------------------------------------
  # LOCAL HOOKS (Project-Specific Scripts)
  # Autofixing and critical checks tailored to the NPM workspace setup.
  # ------------------------------------------------------------------------------
  - repo: local
    hooks:
      - id: sort-package-json
        name: 'Sort package.json files'
        entry: npx --no-install sort-package-json "package.json" "packages/*/package.json" "apps/*/package.json"
        language: system
        types: [json]
        files: '^(package\.json|packages/.*/package\.json|apps/.*/package\.json)$'

      - id: tsc-core
        name: 'TypeScript type check (core)'
        entry: npm run type-check
        language: system
        pass_filenames: false

      - id: tsc-web
        name: 'TypeScript type check (web)'
        entry: bash -c 'npm run build:core && npm run build:platform && cd apps/web && npx tsc --noEmit'
        language: system
        files: ^apps/web/src/.*\.(ts|tsx)$
        pass_filenames: false

      - id: eslint
        name: 'ESLint (TypeScript/React quality)'
        entry: npx --no-install eslint --fix --no-warn-ignored
        language: system
        files: ^(packages|apps)/.*\.(js|ts|tsx)$
        exclude: (tests|\.test\.|\.spec\.|\.config\.)
        pass_filenames: true

      - id: docker-compose-check
        name: 'Docker Compose config validation'
        entry: docker compose -f docker-compose.yml config -q
        language: system
        files: ^docker-compose\.yml$
        pass_filenames: false

      - id: npm-audit
        name: 'npm audit (production security vulnerabilities)'
        entry: npm audit --audit-level=high --omit=dev
        language: system
        files: ^package(-lock)?\.json$
        pass_filenames: false
        stages: [pre-push]

      - id: docker-build
        name: 'Docker build validation'
        entry: docker build -t yaytsa:test -f apps/web/Dockerfile .
        language: system
        # Trigger on: Dockerfile, entrypoint, nginx config, TS/JS sources, package.json
        files: ^(apps/web/Dockerfile|apps/web/docker/|infra/nginx/|packages/|package\.json)
        pass_filenames: false
        stages: [pre-push]

      - id: commitlint
        name: 'Commitlint (conventional commits)'
        entry: npx --no-install commitlint --edit
        language: system
        stages: [commit-msg]
        always_run: true

      - id: knip
        name: 'Knip (unused code detection)'
        entry: npx --no-install knip --no-progress --exclude unresolved
        language: system
        pass_filenames: false

      - id: jscpd
        name: 'Copy-paste detection (jscpd)'
        entry: >-
          npx --no-install jscpd --min-lines 6 --min-tokens 50 --threshold 3
          --ignore "**/tests/**,**/node_modules/**,**/dist/**,**/build/**"
          packages/ apps/
        language: system
        files: \.(js|ts|tsx)$
        pass_filenames: false

      - id: type-coverage
        name: 'Type coverage (>=90%)'
        entry: npx --no-install type-coverage --at-least 90 --ignore-catch
        language: system
        pass_filenames: false

      # --------------------------------------------------------------------------
      # REACT/TAILWIND HOOKS (apps/web)
      # React-specific quality checks for the frontend.
      # --------------------------------------------------------------------------
      - id: no-console
        name: 'No console.log in production'
        entry: >-
          bash -c 'grep -rn "console\.\(log\|debug\)" apps/web/src/{features,routes,components}
          --include="*.ts" --include="*.tsx" 2>/dev/null && exit 1 || exit 0'
        language: system
        files: ^apps/web/src/.*\.(ts|tsx)$
        pass_filenames: false

      - id: component-naming
        name: 'Component naming convention (PascalCase)'
        entry: >-
          bash -c 'find apps/web/src -name "*.tsx" -exec basename {} \; |
          grep -vE "^[A-Z]|^(index|main|vite-env)" && exit 1 || exit 0'
        language: system
        files: ^apps/web/src/.*\.tsx$
        pass_filenames: false

      # --------------------------------------------------------------------------
      # JAVA BACKEND HOOKS (services/server)
      # Uses existing Maven plugins: SpotBugs, PMD, Enforcer from pom.xml
      # --------------------------------------------------------------------------
      - id: maven-compile
        name: 'Maven compile (Java backend)'
        entry: bash -c 'cd services/server && mvn compile -B -q'
        language: system
        files: ^services/server/(pom\.xml|src/.*)$
        pass_filenames: false

      - id: maven-spotbugs
        name: 'SpotBugs (Java static analysis)'
        entry: bash -c 'cd services/server && mvn spotbugs:check -B -q'
        language: system
        files: ^services/server/src/main/.*\.java$
        pass_filenames: false

      - id: maven-pmd
        name: 'PMD (Java code quality)'
        entry: bash -c 'cd services/server && mvn pmd:check -B -q'
        language: system
        files: ^services/server/src/main/.*\.java$
        pass_filenames: false
