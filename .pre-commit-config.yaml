minimum_pre_commit_version: '3.5.0'
default_stages: [pre-commit]
default_language_version:
  node: system
fail_fast: false # Run all hooks to get complete feedback

repos:
  # ------------------------------------------------------------------------------
  # GENERAL FILE HYGIENE (Mostly Autofixing)
  # Basic checks and fixes for all text files.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace # [AUTOFIX] Removes trailing whitespace.
        args: [--markdown-linebreak-ext=md]
      - id: end-of-file-fixer # [AUTOFIX] Ensures files end with a newline.
      - id: mixed-line-ending # [AUTOFIX] Forces LF line endings.
        args: [--fix=lf]
      - id: fix-byte-order-marker # [AUTOFIX] Removes UTF-8 BOM.
      - id: check-added-large-files # [CHECK] Prevents committing large files (>1MB).
        args: [--maxkb=1024]
      - id: check-merge-conflict # [CHECK] Prevents committing merge conflict markers.
      - id: check-case-conflict # [CHECK] Catches file path case inconsistencies.
      - id: detect-private-key # [CHECK] Prevents leaking private keys.
      - id: check-json # [CHECK] Validates JSON syntax.
      - id: check-yaml # [CHECK] Validates YAML syntax.
        args: [--unsafe] # Specific to this project: Allows custom Docker Compose tags.
        exclude: ^helm/.*/templates/.*\.yaml$ # Exclude Helm templates (use Go templating)

  # ------------------------------------------------------------------------------
  # PRETTIER CODE FORMATTER (Autofixing)
  # The main formatter for TS, Svelte, YAML, MD, and CSS.
  # Uses the project's existing .prettierrc file.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8 # Using a version that better supports Svelte
    hooks:
      - id: prettier
        types_or: [javascript, svelte, css, scss, markdown, yaml, json]
        args: [--write, --ignore-unknown]
        exclude: ^(package-lock\.json|pnpm-lock\.yaml|yarn\.lock)$
        # Exclusions are managed by your existing .prettierignore file.

  # ------------------------------------------------------------------------------
  # MARKDOWN LINTING (Autofixing)
  # Lints and fixes Markdown files using your existing .markdownlint.yaml config.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.45.0
    hooks:
      - id: markdownlint
        args: [--fix, --config, .markdownlint.yaml]

  # ------------------------------------------------------------------------------
  # SHELL SCRIPT FORMATTING & LINTING (Autofixing + Check)
  # Specific to this project: docker-entrypoint.sh, run-integration-tests.sh, etc.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/scop/pre-commit-shfmt
    rev: v3.12.0-2
    hooks:
      - id: shfmt # [AUTOFIX] Formats shell scripts for consistency.
        args: [-w, -i, '2'] # -w: write changes, -i 2: indent with 2 spaces.

  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.11.0.1
    hooks:
      - id: shellcheck # [CHECK] Lints shell scripts for common errors.
        args: [-x]

  # ------------------------------------------------------------------------------
  # DOCKER & INFRASTRUCTURE LINTING (Quality & Security)
  # Validates Dockerfiles, docker-compose, and infrastructure config.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/hadolint/hadolint
    rev: v2.14.0
    hooks:
      - id: hadolint-docker # [CHECK] Dockerfile best practices and security linting.
        args: [--config, .hadolint.yaml]

  # ------------------------------------------------------------------------------
  # SECRET DETECTION (Security)
  # Prevents committing secrets, API keys, tokens, and credentials.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.28.0
    hooks:
      - id: gitleaks # [CHECK] Scans for hardcoded secrets and credentials.

  # ------------------------------------------------------------------------------
  # SEMANTIC SECURITY ANALYSIS (Advanced)
  # AST-based security scanner for JavaScript/TypeScript.
  # More powerful than basic ESLint security rules.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/returntocorp/semgrep
    rev: v1.89.0
    hooks:
      - id: semgrep
        name: semgrep (JS/TS security & best practices)
        args:
          - --config=p/javascript
          - --config=p/typescript
          - --config=p/react
          - --error
          - --skip-unknown-extensions
          - --metrics=off
        files: ^(packages|apps)/.*\.(js|ts|svelte)$

  # ------------------------------------------------------------------------------
  # SPELL CHECKING (Documentation Quality)
  # Reduces typos in code, comments, and documentation.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/codespell-project/codespell
    rev: v2.4.1
    hooks:
      - id: codespell
        name: codespell (spell checker)
        args:
          - --write-changes
          - --ignore-words-list=afterall,beforeall,aftereach,beforeeach,alltogether
          - --skip=package-lock.json,pnpm-lock.yaml,jellyfin-api-spec.json,node_modules,.svelte-kit,dist,build

  # ------------------------------------------------------------------------------
  # YAML LINTING (Strict Validation)
  # More comprehensive than basic check-yaml.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.37.1
    hooks:
      - id: yamllint
        name: yamllint (YAML linting)
        args:
          - -d
          - >-
            {extends: default,
            rules: {line-length: {max: 120},
            document-start: disable,
            indentation: disable,
            comments: disable}}
        exclude: ^(helm/.*/templates/.*\.yaml|\.github/.*\.yml)$

  # ------------------------------------------------------------------------------
  # GITHUB ACTIONS VALIDATION (CI/CD Quality)
  # Validates GitHub Actions workflow syntax and best practices.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/rhysd/actionlint
    rev: v1.7.8
    hooks:
      - id: actionlint-docker # [CHECK] Lints GitHub Actions workflow files.

  # ------------------------------------------------------------------------------
  # CSS QUALITY (Stylelint)
  # Validates CSS in .css files and Svelte components.
  # ------------------------------------------------------------------------------
  - repo: https://github.com/thibaudcolas/pre-commit-stylelint
    rev: v16.25.0
    hooks:
      - id: stylelint # [CHECK/AUTOFIX] CSS quality and consistency.
        args: [--fix, --config, .stylelintrc.json]
        additional_dependencies:
          - stylelint@16.12.0
          - stylelint-config-standard@29.0.0
          - stylelint-config-recommended@13.0.0

  # ------------------------------------------------------------------------------
  # LOCAL HOOKS (Project-Specific Scripts)
  # Autofixing and critical checks tailored to the NPM workspace setup.
  # ------------------------------------------------------------------------------
  - repo: local
    hooks:
      - id: sort-package-json
        name: 'Sort package.json files'
        entry: npx sort-package-json "package.json" "packages/*/package.json" "apps/*/package.json"
        language: node
        types: [json]
        files: '^(package\.json|packages/.*/package\.json|apps/.*/package\.json)$'

      - id: tsc-core
        name: 'TypeScript type check (core)'
        entry: npm run type-check # This runs `npx tsc --noEmit` inside packages/core
        language: node
        pass_filenames: false

      - id: svelte-check
        name: 'Svelte type check (web)'
        entry: bash -c 'npm run build:core && npm run build:platform && npm run check --workspace=@yaytsa/web'
        language: system
        pass_filenames: false

      - id: eslint
        name: 'ESLint (TypeScript/Svelte quality)'
        entry: npx eslint --fix
        language: node
        files: ^(packages|apps)/.*\.(js|ts|svelte)$
        pass_filenames: true

      - id: docker-compose-check
        name: 'Docker Compose config validation'
        entry: docker compose -f docker-compose.yml config -q
        language: system
        files: ^docker-compose\.yml$
        pass_filenames: false

      - id: npm-audit
        name: 'npm audit (production security vulnerabilities)'
        entry: npm audit --audit-level=high --production
        language: node
        files: ^package(-lock)?\.json$
        pass_filenames: false

      - id: docker-build
        name: 'Docker build validation'
        entry: docker build -t yaytsa:test -f apps/web/Dockerfile .
        language: system
        files: >-
          ^(apps/web/Dockerfile|apps/web/docker/entrypoint\.sh|deploy/nginx/nginx\.conf\.template|
          packages/.*/.*\.(ts|svelte|js|json)|apps/web/.*\.(ts|svelte|js|json)|package\.json)$
        pass_filenames: false
        stages: [pre-push]

      - id: commitlint
        name: 'Commitlint (conventional commits)'
        entry: npx commitlint --edit
        language: node
        stages: [commit-msg]
        always_run: true

      - id: knip
        name: 'Knip (unused code detection)'
        entry: npx knip --no-progress --exclude unresolved
        language: node
        pass_filenames: false

      - id: jscpd
        name: 'Copy-paste detection (jscpd)'
        entry: >-
          npx jscpd --min-lines 6 --min-tokens 50 --threshold 3
          --ignore "**/tests/**,**/node_modules/**,**/dist/**,**/.svelte-kit/**"
          packages/ apps/
        language: node
        files: \.(js|ts|svelte)$
        pass_filenames: false

      - id: type-coverage
        name: 'Type coverage (>=90%)'
        entry: npx type-coverage --at-least 90 --ignore-catch
        language: node
        pass_filenames: false
